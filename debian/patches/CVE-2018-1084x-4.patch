Backport of:

From c433cdf92349afae66c703bdacedf987f423605e Mon Sep 17 00:00:00 2001
From: Nikos Mavrogiannopoulos <nmav@redhat.com>
Date: Tue, 12 Jun 2018 14:31:40 +0200
Subject: [PATCH] hmac-sha384 and sha256 ciphersuites were removed from
 defaults

These ciphersuites are deprecated since the introduction of AEAD
ciphersuites, and are only necessary for compatibility with older
servers. Since older servers already support hmac-sha1 there is
no reason to keep these ciphersuites enabled by default, as they
increase our attack surface.

Relates #456

Signed-off-by: Nikos Mavrogiannopoulos <nmav@redhat.com>
---
 lib/priority.c            |  8 --------
 tests/dtls1-2-mtu-check.c |  2 +-
 tests/priorities.c        | 12 ++++++------
 3 files changed, 7 insertions(+), 15 deletions(-)

Index: gnutls28-3.4.10/lib/gnutls_priority.c
===================================================================
--- gnutls28-3.4.10.orig/lib/gnutls_priority.c	2019-05-28 13:29:18.707910302 -0400
+++ gnutls28-3.4.10/lib/gnutls_priority.c	2019-05-28 13:29:18.703910285 -0400
@@ -386,8 +386,6 @@ static const int* sign_priority_secure19
 
 static const int mac_priority_normal_default[] = {
 	GNUTLS_MAC_SHA1,
-	GNUTLS_MAC_SHA256,
-	GNUTLS_MAC_SHA384,
 	GNUTLS_MAC_AEAD,
 	GNUTLS_MAC_MD5,
 	0
@@ -395,8 +393,6 @@ static const int mac_priority_normal_def
 
 static const int mac_priority_normal_fips[] = {
 	GNUTLS_MAC_SHA1,
-	GNUTLS_MAC_SHA256,
-	GNUTLS_MAC_SHA384,
 	GNUTLS_MAC_AEAD,
 	0
 };
@@ -421,16 +417,12 @@ static const int* mac_priority_suiteb =
 
 static const int _mac_priority_secure128[] = {
 	GNUTLS_MAC_SHA1,
-	GNUTLS_MAC_SHA256,
-	GNUTLS_MAC_SHA384,
 	GNUTLS_MAC_AEAD,
 	0
 };
 static const int* mac_priority_secure128 = _mac_priority_secure128;
 
 static const int _mac_priority_secure192[] = {
-	GNUTLS_MAC_SHA256,
-	GNUTLS_MAC_SHA384,
 	GNUTLS_MAC_AEAD,
 	0
 };
Index: gnutls28-3.4.10/tests/priorities.c
===================================================================
--- gnutls28-3.4.10.orig/tests/priorities.c	2019-05-28 13:29:18.707910302 -0400
+++ gnutls28-3.4.10/tests/priorities.c	2019-05-28 13:31:01.928350476 -0400
@@ -101,18 +101,18 @@ try_prio(const char *prio, unsigned expe
 
 void doit(void)
 {
-	const int normal = 54;
-	const int null = 5;
-	const int sec128 = 50;
+	const int normal = 38;
+	const int null = 4;
+	const int sec128 = 34;
 
 	try_prio("NORMAL", normal, 11, __LINE__);
 	try_prio("NORMAL:-MAC-ALL:+MD5:+MAC-ALL", normal, 11, __LINE__);
 	try_prio("NORMAL:+CIPHER-ALL", normal, 11, __LINE__);	/* all (except null) */
 	try_prio("NORMAL:-CIPHER-ALL:+NULL", null, 1, __LINE__);	/* null */
 	try_prio("NORMAL:-CIPHER-ALL:+NULL:+CIPHER-ALL", normal + null, 12, __LINE__);	/* should be null + all */
-	try_prio("NORMAL:-CIPHER-ALL:+NULL:+CIPHER-ALL:-CIPHER-ALL:+AES-128-CBC", 8, 1, __LINE__);	/* should be null + all */
+	try_prio("NORMAL:-CIPHER-ALL:+NULL:+CIPHER-ALL:-CIPHER-ALL:+AES-128-CBC", 4, 1, __LINE__);	/* should be null + all */
 	try_prio("PERFORMANCE", normal, 11, __LINE__);
-	try_prio("SECURE256", 19, 5, __LINE__);
+	try_prio("SECURE256", 11, 5, __LINE__);
 	try_prio("SECURE128", sec128, 10, __LINE__);
 	try_prio("SECURE128:+SECURE256", sec128, 10, __LINE__);	/* should be the same as SECURE128 */
 	try_prio("SECURE128:+SECURE256:+NORMAL", normal, 11, __LINE__);	/* should be the same as NORMAL */
